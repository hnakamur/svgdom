<html>
<head>
<title>text1</title>
<script src="../svgweb/src/svg.js" data-path="../svgweb/src/"></script>
<script>
window.onload = function() {
  var svg1 = document.getElementById('svg1');
  var text1 = document.getElementById('text1');

  var lines = 'A multiline\ntext2\ntext\nand text text'.split('\n');
  var maxWidth = 0;
  var widths = [];
  var startIndex = 0;
  for (var i = 0, n = lines.length; i < n; ++i) {
    var line = lines[i];
    var width = text1.getSubStringLength(startIndex, line.length);
    var sp = text1.getExtentOfChar(startIndex);
    var ep = text1.getExtentOfChar(startIndex + line.length - 1);
//    var sp = text1.getStartPositionOfChar(startIndex);
//    var ep = text1.getEndPositionOfChar(startIndex + line.length - 1);
    var rectElem = document.createElementNS(svgns, 'rect');
    rectElem.setAttribute('x', sp.x);
    rectElem.setAttribute('y', sp.y);
    rectElem.setAttribute('width', ep.x+ep.width - sp.x);
    rectElem.setAttribute('height', ep.y+ep.height - sp.y);
    rectElem.setAttribute('stroke', '#0f0');
    rectElem.setAttribute('fill', 'none');
    svg1.appendChild(rectElem);

    width = ep.x+ep.width - sp.x;
//    width = ep.x - sp.x;
    console.log('width[' + i + ']=' + width);
    widths.push(width);
    maxWidth = Math.max(maxWidth, width);
    startIndex += line.length;
  }

  var handleId = svg1.suspendRedraw(5);
  var node = text1.firstChild;
  var nodes = [];
  var x = +text1.getAttribute('x');
  for (var i = 0, n = lines.length; i < n; ++i) {
//    if (i == 0)
//      node.setAttribute('dx', maxWidth-widths[i]);
//    else
//      node.setAttribute('dx', -widths[i]);

//    if (i == n - 1)
//      node.removeAttribute('dx');
//    else
      node.setAttribute('dx', -widths[i]);
      
    var sibling = node.nextSibling;
    nodes.push(text1.removeChild(node));
    node = sibling;
  }
  for (var i = 0, n = lines.length; i < n; ++i) {
    text1.appendChild(nodes[i]);
  }
  svg1.unsuspendRedraw(handleId);
}
</script>
</head>
<body>
  <h1>Tests embedding a single SVG block into a SCRIPT block</h1>
  <script type="image/svg+xml">
    <svg width="1200" height="1200" 
         version="1.1"
         xmlns="http://www.w3.org/2000/svg" id="svg1">
      <rect x="200" y="200" width="100" height="50" stroke='#00f' fill='none'/>
      <text x="200" y="200" text-anchor="end" id="text1"
          font-family="Helvetica" font-size="16px">
        <tspan>A multiline</tspan>
        <tspan dy="1.2em">text2</tspan>
        <tspan dy="1.2em">text</tspan>
        <tspan dy="1.2em">and text text</tspan>
      </text>
    </svg>
  </script>
</body>
</html>
